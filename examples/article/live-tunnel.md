# live-tunnel传输行情数据的分析

## 目标

1. 支持全局提醒
2. 支持对具体某个页面的数据更新
3. 后续前端做成单页应用后需要能够低成本迁移

## 功能

1. 支持基于机构的实时提醒
2. 支持基于用户的实时提醒（同一个用户多开进行了连接）
3. 支持基于权限的实时提醒
4. 支持基于页面的实时提醒（暂不支持，后端与live-tunnel不进行区分，全部透传给前端，让前端自行决定数据是否处理 
// 转念一想，不应该不支持。因为按照设想，前端得到的是持仓变更数据，根据这个数据去修正指令，委托等接口的数据。在基于live-tunnel也由前端维护的前提，前端本身是需要额外准备大量的数据的。接口的数据算是一个level3左右的数据，然后再根据live-tunnel透传的level0的变更数据，是算不出新的level3的数据的才对。
// 得到共识的处理逻辑是，假如委托列表接口和持仓列表接口因为有一条委托成交了而需要变化，后端会返回两个接口的变化行。所以不存在之前考虑到得到前端根据旧的level3和变化的level0的数据计算出新的level3的数据的情况。）

## 风险

~~基于对功能的分析，行情数据通过live-tunnel传输，还有一个前置条件必须解决，即，行情相关level0->level1->level2这样的关系，需要理清楚。~~

## 思路

1. socket进行连接时，会自动进入独立的socket.id的房间。随后，前端会调用用户登录的接口，传入必要的身份信息
2. 该用户调用登录接口时，加入以机构名称命名的房间，以便支持功能1，即支持基于机构进行实时提醒。
3. 该用户调用登录接口时，会将该用户id作为属性名，包含该用户所有socket.id的数组作为属性值，记录下来。
4. 该用户调用登录接口时，会跟后端php进行交互，获取该用户所有的权限颗粒。最终以权限颗粒作为属性名，以包含所有拥有该权限的用户socket.id的数组作为属性值，记录下来。
5. 该用户调用登录接口时，一方面得到后端返回的权限颗粒，另一方面得到前端提供的页面权限颗粒。采用类似于思路4的方式，以页面权限颗粒作为属性名，以包含所有`拥有该权限且前端返回了该页面权限`的用户的socket.id的数组作为属性值，记录下来。




